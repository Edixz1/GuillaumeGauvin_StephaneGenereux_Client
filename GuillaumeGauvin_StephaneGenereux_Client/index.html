<!--------------------------------------------------------------------------------------------------
    Single Page Application
    news MANAGER WEB CLIENT

    LAST UPDATE: 30 november 2020
    Author : Nicolas Chourot
    College Lionel-Groulx
----------------------------------------------------------------------------------------------------->
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta author="Nicolas Chourot">
        <meta http-equiv="Content-Type" content="text/html; charset= ISO-8859-1">
        <title>Gestionnaire de news</title>

        <!---STYLES BUNDLE -------------------------------------------------------------------------->
        <link rel="stylesheet" href="css/jquery-ui.css">  
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

        <!-- Tooltips styles -->
        <link rel="stylesheet" href="css/tooltip.css">
        
        <!-- Confirm dialog styles -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">
        <!-- Font awesome styles -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

         <!-- news manager main layout styles -->
         <link rel="stylesheet" href="css/newsManagerLayout.css">

        <!-- favicon link: use https://favicon.io/favicon-converter/ to create new favicon -->
        <link rel="icon" href="favicon.ico">

        <!---Page backgroung image------------------------------------------------------------------>
        <style>
            body { 
                background: url(images/bg.png) no-repeat center center fixed; 
                -webkit-background-size: cover;
                -moz-background-size: cover;
                -o-background-size: cover;
                background-size: cover;
                }
        </style>
    </head>   
    <body>
        <!---news MANAGER UI CONTAINER--------------------------------------------------------->
        <div class="container">
            <!---TITLE AND USER CONNECTION UI------------------------------------------------------->
           
                       
            <div class="array-container">
                 <!---news LIST HEAD----------------------------------------------------------->
                <div class="header-container">
                    <div class="header-news-container">

                        <div class="title-container">

                            <h1><img src="images/favicon2.png" style="height: 60px; margin-right:8px;float:left;"></h1>

                            <div id="btn_OpenAddnewsDialog" tooltip="Ajouter une news" tooltip-position="left">
                                <span class="gicon glyphicon glyphicon-plus"></span>
                            </div>
                            
                            <div id="sort_Title" class="sortcmd">Titre &nbsp;<span id="dir_Title"></span></div>
                            <div id="sort_Created" class="sortcmd">Date &nbsp;<span id="dir_Created"></span></div>
                            <div id="sort_Username" class="sortcmd">Usager &nbsp;<span id="dir_Username"></span></div>

                            <div id="showSearch" tooltip="Barre de recherche"  tooltip-position="left">
                                <span id="showSearchIcon" class="gicon glyphicon glyphicon-zoom-in" ></span>
                            </div>
                            
                            <div style="margin-top:26px;text-align:right;">
                                <div id="avatarContainer" style="width: 71px;"></div>
                                <h4 id="username"style="width: 71px;">non connectÈ</h4>
                            </div>
                            
                            <div style="margin-top:30px;text-align:right;">
                                <div id="btn_OpenLoginForm" tooltip="Connexion"  tooltip-position="left">
                                    <span id="showSearchIcon" class="giconBig glyphicon glyphicon-log-in" >&nbsp;</span>
                                </div>
                                <div id="btn_OpenConfirmLogout" tooltip="D√©connexion"  tooltip-position="bottom">
                                    <span id="showSearchIcon" class="giconBig glyphicon glyphicon-log-out" >&nbsp;</span>
                                </div>
                                <div id="btn_OpenProfilDialog" tooltip="Enregistrement"  tooltip-position="left">
                                    <img src="images/register.png" id="showRegister" class="icon" >
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>

                <!---SEARCH BAR--------------------------------------------------------------------->
                <div class="searchBar columns-layout">
                    <div><input type="search" placeholder="Titre..." id="search_title"></div>
                    <div><input type="search" placeholder="Usager..." id="search_user"></div>
                </div>
                
                <!---news LIST----------------------------------------------------------------->
                
            
                <div class="news-list-scroll-containter">
                    <!-- Copier √ßa -->
                    <div id="news-list-container" class="news-list-container">
                        <!-- La liste de news sera inject√©e ici par du JavaScript -->
                        <div class="news-container">
                            <div>
                                <img id="user-image-nouvelle" height="50px" width="50px" src='https://miro.medium.com/max/700/1*mk1-6aYaf_Bes1E3Imhc0A.jpeg'>
                                <div id="user-name-nouvelle" class="news-info">Nom</div>
                            </br>
                                <div id="date-nouvelle" class="news-info">2020-12-15</div>
                                
                            </div>

                            <div>
                                <div id="titre-nouvelle" class="news-info">
                                    Titre de la nouvelle
                                </div>
                            </br>
                                <div class="news-info">
                                    <img id="image-nouvelle" width="600px" src='https://miro.medium.com/max/700/1*mk1-6aYaf_Bes1E3Imhc0A.jpeg'>
                                </div>
                            </br>
                                <div id="description-nouvelle" class="news-info">
                                    Lorem ipsum dolor sit amet consectetur, adipisicing elit. Consequuntur eum ad fuga cupiditate aliquid aliquam obcaecati nemo debitis quia eos? Pariatur magni commodi praesentium repellat odit aut blanditiis porro! Consequuntur.
                                    Lorem ipsum dolor sit amet consectetur, adipisicing elit. Consequuntur eum ad fuga cupiditate aliquid aliquam obcaecati nemo debitis quia eos? Pariatur magni commodi praesentium repellat odit aut blanditiis porro! Consequuntur.
                                    Lorem ipsum dolor sit amet consectetur, adipisicing elit. Consequuntur eum ad fuga cupiditate aliquid aliquam obcaecati nemo debitis quia eos? Pariatur magni commodi praesentium repellat odit aut blanditiis porro! Consequuntur.
                                </div>
                            </div>
                            <div id="glyphicon-nouvelle">
                                <span class="gicon glyphicon glyphicon-pencil" ></span>
                                <span class="gicon glyphicon glyphicon-remove" ></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!---news DIALOG------------------------------------------------------------------------>
        <div id="dialog-newsForm" title="news" class="dialog">
            <form id="newsForm" class="form-group">
                    <input type="hidden" id="newsId" />
                    <input type="hidden" id="newsUserId" />
                    <input type="hidden" id="newsGUID" />
                    <input type="hidden" id="newsCreated" />
                    <input type="hidden" id="newslastUpdated" />
                    <input type="text" id="newsTitle" placeholder="Titre" class="form-control"/>
                    <div style="vertical-align:top; text-align: center ">
                        <div class='imageDownloader' id = 'ImageData' defautImageSrc='images/No_image.png'></div>
                        <label>(cliquez pour la changer l'image)</label>
                    </div>
                    <textarea style="resize: none;" type="textbox" id="newsDescription" placeholder="Description"  class="form-control" cols="50" rows="5">
                    </textarea>

            </form>
        </div>
       
        <!---LOGIN DIALOG--------------------------------------------------------------------------->
        <div id="dialog-loginForm" title="Connexion" class="dialog">
            <form id="loginForm" class="form-group">
                <input type="text" id="loginEmail" placeholder="Courriel"  class="form-control"/>
                <input type="password" id="loginPassword" placeholder="Mot de passe" class="form-control"/>
                <br>
                <div class="form-group form-check">
                    <input type="checkbox" class="form-check-input" id="remember-me">
                    <label class="form-check-label" for="remember-me">Se souvenir de moi</label>
                    </div>
            </form>
        </div>

        <!---PROFIL DIALOG-------------------------------------------------------------------------->
        <div id="dialog-profilForm" title="Profil" class="dialog">
            <form id="profilForm" class="form-group">
                <input type="hidden" id="avatarGUID" />
                <input type="hidden" id="profilId" />
                <input type="text" id="profilUsername" placeholder="Nom d'usager"  class="form-control"/>
                <input type="text" id="profilEmail" placeholder="Courriel"  class="form-control"/>
                <input type="password" id="profilPassword" placeholder="Mot de passe"  class="form-control"/>
                <br>
                <input type="password" id="profilConfirmPassword" placeholder="Confirmation"  class="form-control"/>
                <br>
                <div style="vertical-align:top; text-align: center ">
                    <div class='imageDownloader' id = 'avatar' defautImageSrc='images/No_Avatar.png'></div>
                    <label>(cliquez pour la changer l'avatar)</label>
                </div>
            </form>
        </div>

        <!---SCRIPTS BUNDLE------------------------------------------------------------------------->
        <script src="js/jquery-3.5.1.js"></script>
        <script src="js/jquery-ui.js"></script>
        <script src="js/Validation.js"></script>
        <script src="js/WebAPIRequest.js"></script>
        <script src="js/jquery-confirm.js"></script>
        <script src="js/jquery.maskedinput.js"></script>
        <script src="js/imageUploadUtilities.js"></script>

        <!---news MANAGER UI SCRIPT------------------------------------------------------------->
    
        <script>
            
            "use strict";

            $(document).ready(initUI);

            let editMode = false;
            let addMode = false;
            let newProfil = false;
            let connected = false;
            let queryString = "";
            let search = "";
            let searchShowed = false;
            let sorted = [{field:"Username", desc:false}, {field:"Title", desc:false}];
            let forceRefreshnewsList = false;
            let currentETag = "";
            let previousQueryString = ""; 
            let newsValidationProvider = null;
            let profilValidationProvider = null;
            let pausenewsListPeriodicRefresh = false;

            function initUI() {
                initNewsValidation();
                initProfilValidation();

                initnewsDialog();
                initLoginDialog();
                initProfilDialog();              

                $(".searchBar").hide();
                $('#btn_OpenAddnewsDialog').click(OpenAddnewsDialog);
                $("#btn_OpenLoginForm").click(OpenLoginForm);
                $("#btn_OpenConfirmLogout").click(OpenConfirmLogout);
                $("#btn_OpenProfilDialog").click(OpenProfilDialog);

                $('#showSearch').click(toogleSearchVisibility);
                
                $("#sort_Title").click(updateSort);
                $("#sort_Created").click(updateSort);
                $("#sort_Username").click(updateSort);

                $("input[type=search").on("input", updateHead);

                insertWaitingStatus();
                initnewsListColumnsLayout();
                
                updateHead();
                updateUI(false);
                installPeriodicnewsListRefresh();
            }

            function initnewsListColumnsLayout() {
                createCssClass('.columns-layout',"display: grid; grid-template-columns: 30% 30% 30% 5% 5%;"); 
            }
            function initnewsDialog() {
                $("#dialog-newsForm" ).dialog({ 
                    autoOpen: false,  
                    show: {effect: 'fade', duration: 400},
                    hide: {effect: 'fade', duration: 400},
                    buttons:[
                        {
                            id : 'btn-Savenews',
                            text : 'Soumettre',
                            click : function() {
                                    // Ajout d'un news
                                    if (addMode) {
                                        let news = makenewsFromnewsForm(false);
                                        if (newsValidationProvider.isValid()) {
                                            webAPI_POST(news, ()=>{ getnews(); $("#dialog-newsForm").dialog( "close" ); }, AlertError);
                                        }
                                    } else {
                                        let news = makenewsFromnewsForm(true);
                                        if (newsValidationProvider.isValid()) {
                                            webAPI_PUT(news, ()=>{ getnews(); $("#dialog-newsForm").dialog( "close" ); }, AlertError);
                                        }
                                    }
                            }
                        },
                        {
                            id : 'btn-Cancelnews',
                            text : 'Annuler',
                            click : function(){
                                        $(this).dialog('close');
                                    }
                        }
                    ]
                });
                $('#dialog-newsForm').on('dialogopen', function(event) {
                    pausenewsListPeriodicRefresh = true;
                    $('#btn-Savenews').addClass("btn btn-primary");
                    $('#btn-Cancelnews').addClass("btn btn-secondary");
                    $('#newsTitle').val("");
                    $('#newsDescription').val(""); // todo set UserId field
                    clearImageData('news');
                    $("#newshared").prop("checked",true);
                    /// Tres important si on veut que la news par defaut soit affich√©e dans le dialogue
                    setImageDownloaderBlankImage('news');
                    $("#newsUserId").val(retrieveLoggedUser().Id);
                    $("#btn_OpenAddnewsDialog").hide();
                });
                $('#dialog-newsForm').on('dialogclose', function(event) {
                    addMode = false;
                    editMode= false;
                    pausenewsListPeriodicRefresh = false;
                    resetNewsValidation();
                    $("#btn_OpenAddnewsDialog").show();
                });
            }            
            function OpenAddnewsDialog() {
                addMode = true;
                $('#dialog-newsForm').dialog('option', 'title', 'Ajout de news');
                $("#dialog-newsForm" ).dialog( 'open' );
            }
            function OpenEditnewsDialog(e){
                editMode = true;
                $('#dialog-newsForm').dialog('option', 'title', 'Modification de news');
                $("#dialog-newsForm").dialog( 'open' );
                let newsId = e.currentTarget.id.split('_')[1];
                webAPI_GET(newsId, fillEditnewsForm, AlertError);
            }
            function fillEditnewsForm(news) {
                $('#newsId').val(news.Id); 
                $('#newsUserId').val(news.UserId);
                $('#newsGUID').val(news.GUID);
                $('#newsTitle').val(news.Title);
                $('#newsCreated').val(news.Created);
                $('#newsLastUpdated').val(news.LastUpdate);
                $('#newsDescription').val(news.Content);
                clearImageData('ImageData');
                if (news.OriginalURL != ""){
                
                /// Tres important si on veut que la news soit affich√©e dans le dialogue
               
                    setImageDownloaderImage('ImageData', news.OriginalURL);
                }
                else
                    setImageDownloaderBlankImage('ImageData');
                //<div class='imageDownloader' id = 'news' defautImageSrc='images/No_image.png'></div>
            }
           
            function makenewsFromnewsForm(includeId = false) {
                if (includeId) {
                    // R√©cup√©ration du Id du news dans le contr√¥le cach√©
                    return {Id: parseInt($('#newsId').val()), 
                            Title: $('#newsTitle').val(), 
                            Content: $('#newsDescription').val(), 
                            Created: $('#newsCreated').val(), 
                            LastUpdate: $('#newslastUpdated').val(), 
                            GUID: $('#newsGUID').val(),
                            UserId: parseInt($('#newsUserId').val()),
                            ImageData : getImageData('ImageData')
                        };
                }
                return {    Id: 0, 
                            Title: $('#newsTitle').val(), 
                            Content: $('#newsDescription').val(), 
                            Created: $('#newsCreated').val(), 
                            LastUpdate: $('#newsCreated').val(), 
                            GUID: $('#newsGUID').val(),
                            UserId: parseInt($('#newsUserId').val()),
                            ImageData : getImageData('ImageData')
                        };
            }
            function deletenews(e) {
                // Extraction du Id du news inscrit dans l'attribut id de l'√©l√©ment d√©clencheur de l'√©v√©nement click
                let newsId = parseInt(e.currentTarget.id.split('_')[1]);
                webAPI_GET(newsId, confirmDeletenews, AlertError);
            }
            function confirmDeletenews(news) {
                $.confirm({
                    title: 'Retrait de news',
                    content: '<b>' + news.Title +'</b>?',
                    buttons: {
                        confirmer: function () {
                            webAPI_DELETE(news.Id, getnews, AlertError);
                        },
                        annuler: {},
                    }
                });
            }

            function initProfilDialog() {
                $("#dialog-profilForm" ).dialog(
                    {   autoOpen: false,
                        show: {effect: 'fade', speed: 400},
                        hide: {effect: 'fade', speed: 400},
                        buttons:[
                            {
                                id : 'btn-SaveProfil',
                                text : 'Enregister',
                                click : function() {
                                    let profilFromForm = {  Id: parseInt($("#profilId").val()),
                                                            Name: $("#profilUsername").val(),
                                                            Email: $("#profilEmail").val(),
                                                            Password: $("#profilPassword").val(),
                                                            AvatarGUID: $("#avatarGUID").val(),
                                                            ImageData : getImageData('avatar')
                                                        }
                                    if (connected)
                                        webAPI_ChangeProfil(profilFromForm, ()=>{$("#dialog-profilForm").dialog( "close" ); updateUI(true);}, AlertError);
                                    else {
                                        profilFromForm.Id = 0;
                                        webAPI_Register(profilFromForm, ()=>{$("#dialog-profilForm").dialog( "close" ); updateUI(true);}, AlertError);
                                    }
                                }
                            },
                            {
                                id : 'btn-CancelProfil',
                                text : 'Annuler',
                                click : function(){
                                            $(this).dialog('close');
                                        }
                            },
                            {
                                id : 'btn-deleteProfil',
                                text : 'D√©sinscription',
                                click : function (){
                                    confirmDeleteAccount();
                                }
                            }
                        ]
                        });
                $('#dialog-profilForm').on('dialogopen', function(event) {
                    pausenewsListPeriodicRefresh = true;
                    $("#profilId").val(0);
                    $('#btn-SaveProfil').addClass("btn btn-primary");
                    $('#btn-deleteProfil').addClass("btn btn-danger");
                    $('#btn-CancelProfil').addClass("btn btn-secondary");
                    if (connected) {
                        $('#dialog-profilForm').dialog('option', 'title', 'Modification de votre profil...');
                        $("#profilId").val(retrieveLoggedUser().Id);
                        $('#profilUsername').val(retrieveLoggedUser().Name);
                        $('#profilEmail').val(retrieveLoggedUser().Email);
                        $('#avatarGUID').val(retrieveLoggedUser().AvatarGUID);
                        if (retrieveLoggedUser().AvatarURL != "")
                            setImageDownloaderImage('avatar', retrieveLoggedUser().AvatarURL);
                        else
                            setImageDownloaderBlankImage('avatar');
                        $('#btn-deleteProfil').show();
                    } else {
                        $('#dialog-profilForm').dialog('option', 'title', 'Cr√©ation de compte...');
                        $('#profilUsername').val("");
                        $('#profilEmail').val("");
                        setImageDownloaderBlankImage('avatar');
                        $('#btn-deleteProfil').hide();
                    }
                    $('#profilPassword').val("");
                    $('#profilConfirmPassword').val("");
                    $("#btn_OpenAddnewsDialog").hide();
                });
                $('#dialog-profilForm').on('dialogclose', function(event) {
                    pausenewsListPeriodicRefresh = false;
                    resetProfilValidation();
                    if (connected)
                        $("#btn_OpenAddnewsDialog").show();
                });
            }
            function OpenProfilDialog() {
                pausenewsListPeriodicRefresh = true;
                $("#dialog-profilForm" ).dialog('open');
            }
            function confirmDeleteAccount() {
                pausenewsListPeriodicRefresh = true;
                $.confirm({
                    title: 'Retrait de compte',
                    content: '<b>Voulez-vous vraiment effacer votre compte <br>ainsi que toutes vos news?</b>',
                    buttons: {
                        confirmer:  
                            function () {
                                if (connected) {
                                    webAPI_DELETE_Account(retrieveLoggedUser().Id, 
                                        function () {
                                            closeAllDialog();
                                            pausenewsListPeriodicRefresh = false;
                                            forceLogout();
                                        }, 
                                        AlertError);
                                }
                            },
                        annuler: {},
                    }
                });
            }

            function initLoginDialog() {
                $("#dialog-loginForm" ).dialog(
                    {   autoOpen: false,
                        show: {effect: 'fade', speed: 400},
                        hide: {effect: 'fade', speed: 400},
                        buttons:[
                        {
                            id : 'btn-OkLogin',
                            text : 'Ok',
                            click : function() {
                                pausenewsListPeriodicRefresh = false;
                                webAPI_login($( "#loginEmail").val(), 
                                                $("#loginPassword").val(), 
                                                ()=>{
                                                    $("#dialog-loginForm").dialog( "close" ); 
                                                    updateUI(true);
                                                }, 
                                                failLogin);
                            }
                        },
                        {
                            id : 'btn-CancelLogin',
                            text : 'Annuler',
                            click : function(){
                                        $(this).dialog('close');
                                    }
                        }
                    ]
                    });
                $('#dialog-loginForm').on('dialogopen', function(event) {
                    pausenewsListPeriodicRefresh = true;
                    if (localStorage.getItem('rememberme') == "1") {
                        $("#remember-me").attr("checked","checked");
                        let email = localStorage.getItem('loginemail');
                        let password = localStorage.getItem('loginpassword');
                        if (email) $("#loginEmail").val(email);
                        if (password) $("#loginPassword").val(password);
                    } else {
                        $("#loginEmail").val("");
                        $("#loginPassword").val("");
                    }
                });
                $('#dialog-loginForm').on('dialogclose', function(event) {
                   pausenewsListPeriodicRefresh = false;
                   if ($('#remember-me').is(":checked")) {
                        localStorage.setItem('rememberme', "1");
                        localStorage.setItem('loginemail', $("#loginEmail").val());
                        localStorage.setItem('loginpassword', $("#loginPassword").val());
                    } else {
                        localStorage.setItem('rememberme', "0");
                        localStorage.removeItem('loginemail');
                        localStorage.removeItem('loginpassword');
                    }    
                });
            }
            function OpenConfirmLogout() {
                $.confirm({
                    title: 'D√©connection...',
                    content: 'Voulez-vous vous d√©connecter?',
                    buttons: {
                        confirmer: function () {
                            pausenewsListPeriodicRefresh = false;
                            webAPI_logout(retrieveLoggedUser().Id, updateUI, AlertError);
                        },
                        annuler: {},
                    }
                });
            }
            function OpenLoginForm() {
                $('#btn-OkLogin').addClass("btn btn-primary");
                $('#btn-CancelLogin').addClass("btn btn-secondary");
                $("#dialog-loginForm" ).dialog( 'open' );
            }
            function setUsername(username) {
                $("#username").html("<span id='link_OpenProfilDialog' style='color:blue;' tooltip='Modifier votre profil' class='clickable'>" + username + "</span>");
                $("#link_OpenProfilDialog").click(OpenProfilDialog);
            }
            function unsetUsername() {
                $("#username").html("<span style='color:gray'>non connect√©</span>");
            }
            function failLogin() {
                Alert("Connexion √©chou√©e");
                connected = false;
                unsetUsername();
                updateUI(true);
            }       
            function updateConnected() {
                connected = false;
                let username="";
                if (retrieveLoggedUser() != null) {
                    username = retrieveLoggedUser().Name;
                    connected = true;
                }
                if (connected) {
                    setUsername(username);
                    $("#avatarContainer").empty();
                    $("#avatarContainer").append(html_fittedImage(retrieveLoggedUser().AvatarURL,'avatar'));
                    $("#btn_OpenLoginForm").hide();
                    $("#btn_OpenConfirmLogout").show();
                    $("#btn_OpenAddnewsDialog").show();
                    $('#btn_OpenProfilDialog').attr("tooltip", "Profil");
                }
                else {
                    $("#avatarContainer").empty();
                    unsetUsername();
                    $("#btn_OpenLoginForm").show();
                    $("#btn_OpenConfirmLogout").hide();
                    $("#btn_OpenAddnewsDialog").hide();
                    $('#btn_OpenProfilDialog').attr("tooltip", "Cr√©ation de compte");
                }
            }
            
            function installPeriodicnewsListRefresh() {
                setInterval(() => { if (!pausenewsListPeriodicRefresh) getnews(); }, 15000);
            }

            function toogleSearchVisibility() {
                if (searchShowed)
                    hideSearch();
                else
                    showSearch();
                searchShowed = ! searchShowed;
            }
            function hideSearch() {
                $(".searchBar").hide({duration:400});
                $("#showSearchIcon").removeClass("glyphicon glyphicon-zoom-out");
                $("#showSearchIcon").addClass("glyphicon glyphicon-zoom-in");
            }
            function showSearch() {
                $(".searchBar").show({duration:400});
                $("#showSearchIcon").removeClass("glyphicon glyphicon-zoom-in");
                $("#showSearchIcon").addClass("glyphicon glyphicon-zoom-out");
            }
            function updateSort(e){
                let name = e.target.id.split('_')[1];
                $("#dir_"+name).removeClass("glyphicon glyphicon-sort-by-attributes");
                $("#dir_"+name).removeClass("glyphicon glyphicon-sort-by-attributes-alt");
                let found = false;
                for(let i=0; i < sorted.length; i++){
                    if (sorted[i].field == name) {
                        found = true;
                        if (sorted[i].desc)
                            sorted.splice(i,1);
                        else    
                            sorted[i].desc = true;
                        break;
                    }
                }   
                if (!found) 
                    sorted.push({field:name, desc:false});
                updateHead();
            }
            function addSearchKey(key, value) {
                if (value != ""){
                    if (search != "") search += "&";
                    search += key + "=" + value + "*";
                }
            }
            function updateSearch(){ 
                search = "";
                addSearchKey("title", $("#search_title").val());           
                addSearchKey("username", $("#search_user").val());
                
                if (search != "") {
                    if (queryString != "")
                        search = "&" + search;   
                    else
                        search = "?"+ search;
                }
                queryString += search;
                updateUI(true);
            }
            function updateHead() {
                queryString = "";
                let first = true;
                let sortIndex =0;
                sorted.forEach(sort => {
                    if (first) {
                        first = false;
                        queryString += '?';
                    }
                    else queryString += '&';
                    queryString += "sort=" +sort.field.toLowerCase();
                    // opacit√© en fonction du rang de la cl√© de tri
                    $("#dir_"+sort.field).css("opacity", 1-sortIndex/3);
                    if (sort.desc) {
                        queryString += ',desc';
                        $("#dir_"+sort.field).addClass('glyphicon glyphicon-sort-by-attributes-alt');
                    } else
                    $("#dir_"+sort.field).addClass('glyphicon glyphicon-sort-by-attributes');
                    sortIndex ++;
                });
                updateSearch();
            }
            function updateUI(forceRefresh = true){
                forceRefreshnewsList = forceRefresh;
                updateConnected();
                getnews();
                forceRefreshnewsList = false;
            }
            function getnews() {
                console.log("queryString");
                if (forceRefreshnewsList){
                    webAPI_HEAD(getETag, AlertError);
                } else
                    webAPI_HEAD(checkETag, AlertError);
            }
            function getETag(ETag){
                currentETag = ETag;
                webAPI_GET_ALL(queryString, updatenewsList, AlertError);
                console.log("Forced Downloading news");
            }
            function checkETag(ETag){
                if (ETag != currentETag) {
                    webAPI_GET_ALL(queryString, updatenewsList, AlertError);
                    currentETag = ETag;
                    console.log("new ETag Downloading news");
                } else {
                   if (previousQueryString != queryString || forceRefreshnewsList){
                        webAPI_GET_ALL(queryString, updatenewsList, AlertError);
                        previousQueryString = queryString;
                        console.log("new queryString Downloading news");
                    } else {
                            console.log("news list up to date");
                    }
                }
            }
  
            function createCssClass(name, rules){
                var style = document.createElement('style');
                style.type = 'text/css';
                document.getElementsByTagName('head')[0].appendChild(style);
                if(!(style.sheet||{}).insertRule) 
                    (style.styleSheet || style.sheet).addRule(name, rules);
                else
                    style.sheet.insertRule(name+"{"+rules+"}",0);
            }
 
            function insertWaitingStatus(){
                $('#news-list-container').empty()
                $('#news-list-container').append(  makeCell("En attente de r√©ponse du service Web...", "waiting"));
                $('#news-list-container').append($('<img src="images/Loading_icon.gif" alt="waiting"/>'));
            }
            function statusToString(status) {
                let text = "Le server ne r√©pond pas.";
                console.log(status)
                switch (status){
                    case 401: text = "<br>Requ√™te non autoris√©e. <br>Vous devez √™tre connect√©."; break;
                    case 409: text = "<br>Conflit de donn√©es. <br>Requ√™te refus√©e."; break;
                    case 422: text = "<br>Format des donn√©es soumises incorrect. <br>Requ√™te refus√©e."; break;
                }
                return text;
            }
            function closeAllDialog() {
                $(".dialog").dialog("close");
            }
            function forceLogout() {
                Alert("Expiration de permission d'acc√®s. Vous n'√™tes plus connect√©.");
                closeAllDialog();
                deConnect();
                updateUI(true);
            }
            function Alert(message) {
                $.confirm({
                    title: message,
                    content: '',
                    buttons: {
                        fermer: function () { }
                    }
                });
            }
            function AlertError(status) {
                $.confirm({
                    title: "Message provenant du server..." + status,
                    content: '<img src="images/error.png" style="width:60px;margin:10px" alt="httpError"/>' + statusToString(status),
                    buttons: {
                        fermer: function () { 
                            this.close();
                            if (status == 401) {
                                forceLogout();
                            }
                            pausenewsListPeriodicRefresh = true;
                        }
                    }
                });
            }

            function initNewsValidation() {
                newsValidationProvider = new ValidationProvider("newsForm");
                newsValidationProvider.addControl("newsTitle", validate_newsTitle, false /*validateOnLeave*/);
                newsValidationProvider.addControl("newsDescription", validate_newsDescription, false /*validateOnLeave*/);
            }
            function resetNewsValidation() {
                newsValidationProvider.reset();
            }
            function validate_newsTitle(){
                let TBX_Title = document.getElementById("newsTitle");
                if (TBX_Title.value === "")
                    return "Titre manquant";
                return "";
            }
            function validate_newsDescription(){
                let TBX_Description = document.getElementById("newsDescription");
                if (TBX_Description.value === "")
                    return "Description manquante";
                return "";
            }
            function initProfilValidation() {
                profilValidationProvider = null;
                profilValidationProvider = new ValidationProvider("profilForm");
                profilValidationProvider.addControl("profilUsername", validate_ProfilUsername, false /*validateOnLeave*/);
                profilValidationProvider.addControl("profilEmail", validate_ProfilEmail, false /*validateOnLeave*/);
                profilValidationProvider.addControl("profilPassword", validate_ProfilPassword, false /*validateOnLeave*/);
                profilValidationProvider.addControl("profilConfirmPassword", validate_ProfilConfirmPassword, false /*validateOnLeave*/);
            }
            function resetProfilValidation() {
                profilValidationProvider.reset();
            }
            function validate_ProfilUsername(){
                let TBX_Username = document.getElementById("profilUsername");
                if (TBX_Username.value === "")
                    return "Nom d'usager manquant";
                return "";
            }
            function validate_ProfilEmail(){
                let TBX_Email = document.getElementById("profilEmail");
                let EmailRegex = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
                if (TBX_Email.value === "")
                    return "Courriel manquant";
                if (!EmailRegex.test(TBX_Email.value))
                    return "Courriel invalide";
                return "";
            }            
            function validate_ProfilPassword(){
                return "";
            }
            function validate_ProfilConfirmPassword(){
                let TBX_Confirm = document.getElementById("profilConfirmPassword");
                if (TBX_Confirm.value != "") {
                    let TBX_Password = document.getElementById("profilPassword");
                    if (TBX_Confirm.value != TBX_Password.value)
                        return "Diff√©rent du mot de passe."
                }
                return "";
            }

            function cellOver(e){
                if (!addMode && !editMode) {
                    // currentTarget.className contient en principe : 'row_x cell ...'
                    let newsId = e.currentTarget.className.split(' ')[0].split('_')[1];
                    $('#edit_' + newsId).show();
                    $('#delete_' + newsId).show();
                    $('.row_'+newsId).addClass('selectedRow');
                }
            }
            function cellBlur(e){
                if (!editMode) {
                    // currentTarget.className contient en principe : 'row_x cell ...'
                    let newsId = e.currentTarget.className.split(' ')[0].split('_')[1];
                    $('#edit_' + newsId).hide();
                    $('#delete_' + newsId).hide();
                    $('.row_'+newsId).removeClass('selectedRow');
                }
            }
            function makeCell(content, cssClass){
                return $('<div class= "' + cssClass + '">' + content + '</div>');
            }
            function makeButton(cssClass, id, tooltip) {
                return $('<span id="' + id + '" class="'+ cssClass + '" style="margin-rigth:3px;"></span>');
            }
            function makeGlyphIcon(glyphIconId){
                return $("<div class='gicon glyphicon glyphicon-" + glyphIconId + "'></div>");
            }
            function makeHyperLink(url, caption){
                return '<a href="' + url +'"target="_blank">' + caption + '</a>';
            }          
            function makeFavicon(url) {
                // Utiliser l'API de google pour extraire le favicon du site point√© par url
                // retourne un √©l√©ment div comportant le favicon en tant qu'image de fond
                ///////////////////////////////////////////////////////////////////////////
                if (url.slice(-1) != '/') url += '/';
                url = "http://www.google.com/s2/favicons?sz=64&domain=" + url;
                return '<div class="favicon" style="background-image: url(' + url + ');"></div>';
            }
            function html_fittedImage(url, css=''){
                console.log(url);
                return " <img class='"+css+"'  width='498px' src="+url+" />";
            }
            //TODO TEST
            function newsPost(newsPost,loggedUserId){
                let PostContainer=$("<div class='news-container'></div>");

                // Section usager
                let PostInfoContainer=$("<div></div>");
                PostInfoContainer.append($("<img height='50px' width='50px' src='"+newsPost.UserAvatarURL+"'>")); 
                PostInfoContainer.append($("<div>"+newsPost.Username+"</div></br>")); 
                PostInfoContainer.append($("<div>"+formatDate(new Date(newsPost.Created * 1000))+"</div>"));
                PostInfoContainer.append($("</br><div>Last Update:</br>"+formatDate(new Date(newsPost.LastUpdate * 1000))+"</div>"));

                // Section Article
                let PostDescriptionContainer=$("<div></div>");
                PostDescriptionContainer.append($("<div>"+newsPost.Title+"</div></br>"));
                if(newsPost.OriginalURL){
                    let PostImageContainer=$("<div></div>");
                    PostImageContainer.append(html_fittedImage(newsPost.OriginalURL));
                    PostDescriptionContainer.append(PostImageContainer);
                }
                PostDescriptionContainer.append($("</br><div class='contenue'>"+newsPost.Content+"</div></br>"));
                // Section Glyph 
                let PostGlyphContaienr=$("<div></div>");
                if (connected && newsPost.UserId == loggedUserId){
                    PostGlyphContaienr.append(makeButton("editnews", "edit_" + newsPost.Id , "Modifier "+ newsPost.Title).append(makeGlyphIcon('pencil')));

                    PostGlyphContaienr.append(makeButton("deletenews", "delete_" + newsPost.Id , "Effacer "+ newsPost.Title).append(makeGlyphIcon('remove')));
                } 
                

                
                PostContainer.append(PostInfoContainer);
                PostContainer.append(PostDescriptionContainer);
                PostContainer.append(PostGlyphContaienr);
                return PostContainer;

                
               

            }

            function thumbNail(news, loggedUserId){
       
                let thumbnailContainer = $("<div class='thumbnailContainer'></div>");
                let thumbnailHeader = $("<div class='thumbnailHeader ellipsis'></div>");
                if (connected && news.UserId == loggedUserId){
                    // Bouton d'appel √† la modification de la news
                    thumbnailHeader.append(makeButton("editnews", "edit_" + news.Id , "Modifier "+ news.Title).append(makeGlyphIcon('pencil')));
                    // Bouton d'appel au retrait de news
                    thumbnailHeader.append(makeButton("deletenews", "delete_" + news.Id , "Effacer "+ news.Title).append(makeGlyphIcon('remove')));
                } 

                thumbnailHeader.append($("<br><span>" + news.Title + "</span>"));
                thumbnailHeader.append($("<br><span style='font-size:14px;color:green'>" + news.Username + "</span>"));
                thumbnailHeader.append($("<br><span style='font-size:14px;color:lightblue'>" + new Date(news.Created * 1000) + "</span>"));
                thumbnailContainer.append(thumbnailHeader);
                thumbnailContainer.append(html_fittedImage(news.ThumbnailURL, "thumbnail"));
                return thumbnailContainer;
            }
            
            function updatenewsList(news){
                $('#news-list-container').empty();
                let loggedUserId = (retrieveLoggedUser()?retrieveLoggedUser().Id:null);
                    news.forEach(news => {
                            $('#news-list-container').append(newsPost(news, loggedUserId));
                        });
                    $('.editnews').click(OpenEditnewsDialog);
                    $('.deletenews').click(deletenews);
                }
            
            function updatenewsList2(news) {
                // Rafraichir la liste des news
                // param√®tre news: tableau d'objets news
                /////////////////////////////////////////
                var oddRow = true;
                // effacer le tableau affichant la liste des news
                $('#news-list-container').empty();
                let loggedUserId = retrieveLoggedUser().Id;
                // pour tous les news du tableau news
                news.forEach(news => { // cr√©er une nouvelle rang√©e

                    // d√©terminer la couleur de la rang√©e
                    let bgColorRow = "row_" + news.Id + " cell " + (oddRow?  "oddRow": "evenRow") ;
                    let favicon = makeFavicon(news.Url);
                    let title = favicon + news.Name;
                    let link = makeHyperLink(news.Url, title);
                    
                    // Distribution des donn√©es de l'news dans des cellules de la rang√©e
                    $('#news-list-container').append(makeCell(link, bgColorRow + " ellipsis"));
                    $('#news-list-container').append(makeCell(news.Category, bgColorRow + " ellipsis"));
                    if (connected) {
                        if (news.UserId == loggedUserId) {
                            $('#news-list-container').append(makeCell("", bgColorRow + " ellipsis"));
                        } else {
                            $('#news-list-container').append(makeCell(news.Username, bgColorRow + " ellipsis"));
                        }
                    } else {
                        $('#news-list-container').append(makeCell(news.Username, bgColorRow + " ellipsis"));
                    }

                    if (connected && news.UserId == loggedUserId){
                        // Bouton d'appel √† la modification de l'news
                        $('#news-list-container').append(
                            makeCell("", bgColorRow).append(
                                makeButton("editnews", "edit_" + news.Id , "Modifier "+ news.Name).append(
                                    makeGlyphIcon('pencil'))));

                        // Bouton d'appel au retrait de l'news
                        $('#news-list-container').append(
                            makeCell("", bgColorRow).append(
                                makeButton("deletenews", "delete_" + news.Id , "Effacer "+ news.Name).append(
                                    makeGlyphIcon('remove'))));
                    } else {
                        $('#news-list-container').append(makeCell("", bgColorRow));                        
                        $('#news-list-container').append(makeCell("", bgColorRow));
                    }
                    oddRow = !oddRow;
               });
                // r√©tablir la couleur de fond de toutes les rang√©es
                $('.cell').removeClass('selectedRow');

                // Masquer tous les boutons des rang√©es d'news
                $('#news-list-container span').hide();

               $('.editnews').click(OpenEditnewsDialog);
               $('.deletenews').click(deletenews);
               $('#news-list-container span').hide();
               $('.cell').mouseover(cellOver);
               $('.cell').mouseleave(cellBlur);
            }
            function formatDate(date) {
                var d = new Date(date),
                    month = '' + (d.getMonth() + 1),
                    day = '' + d.getDate(),
                    year = d.getFullYear();

                if (month.length < 2) 
                    month = '0' + month;
                if (day.length < 2) 
                    day = '0' + day;

                return [year, month, day].join('-');
            }
        </script>
    </body>
</html>